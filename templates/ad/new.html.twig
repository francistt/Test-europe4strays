{% extends 'base.html.twig' %}

{% block title %}Création d'une annonce
{% endblock %}

{#{% form_theme form 'ad/_collection.html.twig' %}#}

{% block content %}

	<div class="container">
		<h1 class="my-5">Créer une nouvelle annonce</h1>

		{{ form_start(form) }}

		<div class="row">
			<div class="col">
				<div class="card bg-light">
					<div class="card-header">
						<h3 class="card-title">Informations générales</h3>
					</div>
					<div class="alert alert-light">
						{{ form_row(form.name) }}
						{{ form_row(form.type) }}
						{{ form_row(form.age) }}
						{{ form_row(form.sexe) }}
						{{ form_row(form.size) }}
						{{ form_row(form.city) }}
					</div>
				</div>

				<div class="card bg-light mt-3">
					<div class="card-header">
						<h3 class="card-title">Détails de l'annonce</h3>
					</div>
					<div class="alert alert-light">
						{{ form_row(form.introduction) }}
						{{ form_row(form.content) }}
					</div>
				</div>
			</div>
			<div class="col">
				<div class="card bg-light">
					<div class="card-header">
						<h3 class="card-title">Images de l'annonce</h3>
					</div>
					<div class="alert alert-light">
						<div class="upload-image-strip">
							<button type="button" class="file-select-button btn btn-info">
								<i class="fas fa-upload"></i>
								<span class="name-file">
									Télécharger l'image principale</span>
							</button>
							{{ form_row(form.coverImage, {'label': ' '}) }}	
						</div>
						<div class="ad_images" data-prototype="{{ form_widget(form.images.vars.prototype)|e('html_attr') }}"></div>
						<button type="button" class="add_item_link btn btn-primary"  id="add-image" data-collection-holder-class="ad_images">Ajouter une image</button>
					</div>
				</div>
				<div class="alert alert-success mt-3">
					<h2 class="alert-heading">Sauvegarder mon annonce</h2>
					<p>Vous êtes sur le point de créer votre annonce</p>
					<button type="submit" class="btn btn-secondary">
						<i class="fas fa-check"></i>Créer la nouvelle annonce</button>
				</div>
			</div>
		</div>

		{{ form_end(form) }}
	</div>

{% endblock %}

{% block javascripts %}

	<script src="{{ asset('js/ad.js') }}"></script>
	<script src="{{ asset('js/images.js') }}"></script>

	<script>
		jQuery(document).ready(function() {
			// Get the ul that holds the collection of tags
			var $tagsCollectionHolder = $('div.ad_images');
			// add a delete link to all of the existing tag form li elements
			$tagsCollectionHolder.find('div.subform').each(function() {
				addImageFormDeleteLink($(this));
			});
			// count the current form inputs we have (e.g. 2), use that as the new
			// index when inserting a new item (e.g. 2)
			$tagsCollectionHolder.data('index', $tagsCollectionHolder.find('input').length);

			$('body').on('click', '.add_item_link', function(e) {
				var $collectionHolderClass = $(e.currentTarget).data('collectionHolderClass'); // 'element'
				// add a new tag form (see next code block)
				addFormToCollection($collectionHolderClass);
			})
			function addFormToCollection($collectionHolderClass) {
				// Get the ul that holds the collection of tags
				var $collectionHolder = $('.' + $collectionHolderClass); // $('.element')

				// Get the data-prototype explained earlier
				var prototype = $collectionHolder.data('prototype'); // form_widget(form.images.vars.prototype)

				// get the new index
				var index = $collectionHolder.data('index'); // 1 ça va s'incrementer

				var newForm = prototype;
				// You need this only if you didn't set 'label' => false in your tags field in TaskType
				// Replace '__name__label__' in the prototype's HTML to
				// instead be a number based on how many items we have
				// newForm = newForm.replace(/__name__label__/g, index);

				// Replace '__name__' in the prototype's HTML to
				// instead be a number based on how many items we have
				newForm = newForm.replace(/__name__/g, index);

				// increase the index with one for the next item
				$collectionHolder.data('index', index + 1);

				// Display the form in the page in an li, before the "Add a tag" link li
				var $newFormLi = $('<div class="subform"></div>').append(newForm);
				// Add the new form at the end of the list
				$collectionHolder.append($newFormLi);

				 // add a delete link to the new form
    			addImageFormDeleteLink($newFormLi);
			}
			function addImageFormDeleteLink($imageFormDiv) {
				var $removeFormButton = $('<button type="button" class="btn btn-warning"><i class="fas fa-trash"></i></button>');
				$imageFormDiv.append($removeFormButton);

				$removeFormButton.on('click', function(e) {
					// remove the li for the tag form
					$imageFormDiv.remove();
				});
			}


//			$('#add-image').click(function(){
//				// Je récupère le numéro des futurs champs que je vais créer
//				const index = +$('#widgets-counter').val();
//
//				// Je récupère le prototype des entrées
//				const tmpl = $('#ad_images').data('prototype').replace(/__name__/g, index);
//
//				// J'inject ce code au sein de la div
//				$('#ad_images').append(tmpl);
//
//				$('#widgets-counter').val(index + 1);
//
//				// Je gère le bouton supprimer
//				handleDeleteButtons();
//			});

		});

	</script>

{% endblock %}
